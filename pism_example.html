
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Model-data comparison (ex: PISM) &#8212; AntADatabase</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pism_example';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced: Managing the database" href="advanced.html" />
    <link rel="prev" title="Quick start" href="quick_start.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="AntADatabase - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="AntADatabase - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    AntADatabase
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick start</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Model-data comparison (ex: PISM)</a></li>


<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced: Managing the database</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Support and contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contributing</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/antoinehermant/anta_database" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/antoinehermant/anta_database/issues/new?title=Issue%20on%20page%20%2Fpism_example.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/pism_example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Model-data comparison (ex: PISM)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Model-data comparison (ex: PISM)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-layer-mismatch">2D Layer mismatch</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pism-output">PISM output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#query-the-antadatabase">Query the AntADatabase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-pism">Interpolate PISM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#xarray">xarray</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#h5py">h5py</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting">Plotting</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-transect-mismatch">1D Transect mismatch</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="model-data-comparison-ex-pism">
<h1>Model-data comparison (ex: PISM)<a class="headerlink" href="#model-data-comparison-ex-pism" title="Link to this heading">#</a></h1>
<p>Example using the Parallel Ice Sheet Model</p>
<p>PISM includes an englacial layer tracing scheme <a class="reference external" href="https://doi.org/10.5194/tc-15-4539-2021">(Born and Robinson 2021)</a> since its version 2.1 <a class="reference external" href="https://www.pism.io/docs/manual/modeling-choices/dynamics/age.html">(PISM docs)</a></p>
<p>This notebook shows how to make direct use of the AntADatabase and the anta_database module for comparing a model run with PISM and IRH data. It is not meant to be very efficient, but descriptive, and people should be able to take parts of the code to implement it in there diagnostic routines.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="d-layer-mismatch">
<h1>2D Layer mismatch<a class="headerlink" href="#d-layer-mismatch" title="Link to this heading">#</a></h1>
<section id="pism-output">
<h2>PISM output<a class="headerlink" href="#pism-output" title="Link to this heading">#</a></h2>
<p>This example is using output from a regional domain setup around Dome C, East Antarctica. Layers were traced to match the Cavitte et al. 2020 dataset.
Note that PISM time is in second since year 0, while the dated IRHs are in years before 1950. So one has to be careful with the time reference between the dated IRH and the model time.
PISM outputs the ‘isochronal_layer_thickness’ variable, which needs to be converted to isochronal depth. Then we select the layer of interest.
Here is with xarray, but one can use netCDF4:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">pism_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/home/anthe/documents/data/isochrones/pism_output_example/edc_pism_output.nc&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">pism_out</span><span class="p">[</span><span class="s1">&#39;isochronal_layer_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pism_out</span><span class="p">[</span><span class="s1">&#39;isochronal_layer_thickness&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># creating a new variable for layer depths of same shape of layer thicknesses</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pism_out</span><span class="o">.</span><span class="n">deposition_time</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">pism_out</span><span class="p">[</span><span class="s1">&#39;isochronal_layer_depth&#39;</span><span class="p">][:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pism_out</span><span class="o">.</span><span class="n">isochronal_layer_thickness</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">deposition_time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;deposition_time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="n">age</span> <span class="o">=</span> <span class="mi">38000</span> <span class="c1"># note the age is different from the one used in Cavitte et al. 2020 due to different ice core age scale, please ignore</span>
<span class="n">age_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1950</span> <span class="c1"># to account for difference between model time and age scale used for IRHs, the isochrones were seeded at age+1950, and the simulation ran until year 1950.</span>
<span class="n">age_seconds</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">age</span><span class="o">+</span><span class="n">age_offset</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span>
<span class="n">pism_layer</span> <span class="o">=</span> <span class="n">pism_out</span><span class="o">.</span><span class="n">isochronal_layer_depth</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">deposition_time</span><span class="o">=</span><span class="n">age_seconds</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">X_pism</span><span class="p">,</span> <span class="n">Y_pism</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">pism_out</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pism_out</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<span class="n">pism_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">X_pism</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_pism</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="query-the-antadatabase">
<h2>Query the AntADatabase<a class="headerlink" href="#query-the-antadatabase" title="Link to this heading">#</a></h2>
<p>One can query the Database and fetch the files containing the data to compare with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">anta_database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s1">&#39;/home/anthe/documents/data/isochrones/AntADatabase/&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">filter_out</span><span class="p">(</span><span class="n">flight_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;%RAID%&#39;</span><span class="p">,</span> <span class="s1">&#39;2H%&#39;</span><span class="p">,</span> <span class="s1">&#39;2V%&#39;</span><span class="p">,</span> <span class="s1">&#39;HR%&#39;</span><span class="p">,</span> <span class="s1">&#39;BH%&#39;</span><span class="p">,</span> <span class="s1">&#39;H4%&#39;</span><span class="p">])</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;Cavitte_2020&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="s1">&#39;38100&#39;</span><span class="p">)</span> <span class="c1"># compare with 38.1 ka layer</span>

<span class="n">irh_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_files</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpolate-pism">
<h2>Interpolate PISM<a class="headerlink" href="#interpolate-pism" title="Link to this heading">#</a></h2>
<p>Next we loop through the IRH flight line files, interpolate the PISM isochronal layer depth on each flight line coordinates and compute the difference in depth. We concatenate the results in a DataFrame for plotting. Here we show both with xarray, which is provides a convenient interface with the data, and with h5py, which is much faster:</p>
<section id="xarray">
<h3>xarray<a class="headerlink" href="#xarray" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">all_psx</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_psy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_depth_diff</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">irh_files</span><span class="p">:</span>
    <span class="n">irh</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]:</span>
        <span class="n">irh_layer</span> <span class="o">=</span> <span class="n">irh</span><span class="o">.</span><span class="n">IRH_DEPTH</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">IRH_AGE</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">age</span><span class="p">))</span>
        <span class="n">fl_line_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">irh</span><span class="o">.</span><span class="n">PSX</span><span class="p">,</span> <span class="n">irh</span><span class="o">.</span><span class="n">PSY</span><span class="p">))</span>
        <span class="n">pism_depth_interp</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">pism_points</span><span class="p">,</span> <span class="n">pism_layer</span><span class="p">,</span> <span class="n">fl_line_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">depth_diff</span> <span class="o">=</span> <span class="n">pism_depth_interp</span> <span class="o">-</span> <span class="n">irh_layer</span>

        <span class="n">all_psx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">PSX</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">all_psy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">PSY</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">all_depth_diff</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">depth_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="h5py">
<h3>h5py<a class="headerlink" href="#h5py" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

<span class="n">all_psx</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_psy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_depth_diff</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">irh_files</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">irh</span><span class="p">:</span>
        <span class="n">irh_values</span> <span class="o">=</span> <span class="n">irh</span><span class="p">[</span><span class="s1">&#39;IRH_AGE&#39;</span><span class="p">][:]</span>
        <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]:</span>
            <span class="n">irh_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irh_values</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">age</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">irh_index</span> <span class="o">=</span> <span class="n">irh_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">irh_layer</span> <span class="o">=</span> <span class="n">irh</span><span class="p">[</span><span class="s1">&#39;IRH_DEPTH&#39;</span><span class="p">][:,</span> <span class="n">irh_index</span><span class="p">]</span>

            <span class="n">fl_line_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">irh</span><span class="p">[</span><span class="s1">&#39;PSX&#39;</span><span class="p">][:],</span> <span class="n">irh</span><span class="p">[</span><span class="s1">&#39;PSY&#39;</span><span class="p">][:]))</span>
            <span class="n">pism_depth_interp</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">pism_points</span><span class="p">,</span> <span class="n">pism_layer</span><span class="p">,</span> <span class="n">fl_line_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">depth_diff</span> <span class="o">=</span> <span class="n">pism_depth_interp</span> <span class="o">-</span> <span class="n">irh_layer</span>

            <span class="n">all_psx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irh</span><span class="p">[</span><span class="s1">&#39;PSX&#39;</span><span class="p">][:])</span>
            <span class="n">all_psy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irh</span><span class="p">[</span><span class="s1">&#39;PSY&#39;</span><span class="p">][:])</span>
            <span class="n">all_depth_diff</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">depth_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plotting">
<h2>Plotting<a class="headerlink" href="#plotting" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Create DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;PSX&#39;</span><span class="p">:</span> <span class="n">all_psx</span><span class="p">,</span>
    <span class="s1">&#39;PSY&#39;</span><span class="p">:</span> <span class="n">all_psy</span><span class="p">,</span>
    <span class="s1">&#39;Depth_diff&#39;</span><span class="p">:</span> <span class="n">all_depth_diff</span>
<span class="p">})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PSX&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PSY&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Depth_diff&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Iso Depth Difference (m)&#39;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PISM vs Cavitte et al. 2020 Isochronal Depth Difference at 38.1 ka&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PSX [km]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PSY [km]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/29303bb26e646f1a65afefde0bc6aceb0dfce0742802c433c57c617c6b6d0317.png" src="_images/29303bb26e646f1a65afefde0bc6aceb0dfce0742802c433c57c617c6b6d0317.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="d-transect-mismatch">
<h1>1D Transect mismatch<a class="headerlink" href="#d-transect-mismatch" title="Link to this heading">#</a></h1>
<p>It is also useful to simply plot the absolute isochronal layer depth in both PISM and the dataset as well as respective bed resolutions.
First we select a specific transect:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;Cavitte_2020&#39;</span><span class="p">,</span> <span class="n">flight_id</span><span class="o">=</span><span class="s1">&#39;DC_LDC_DIVIDE&#39;</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_files</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">irh</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We select a few layers we want to plot for comparison (one can plot everything, but here there is a lot)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cavitte_ages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">29400</span><span class="p">,</span> <span class="mi">38100</span><span class="p">,</span> <span class="mi">46400</span><span class="p">,</span> <span class="mi">73400</span><span class="p">,</span> <span class="mi">96500</span><span class="p">,</span> <span class="mi">121100</span><span class="p">,</span> <span class="mi">166400</span><span class="p">,</span> <span class="mi">277900</span><span class="p">]</span>
<span class="n">irh_layers</span> <span class="o">=</span> <span class="n">irh</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">IRH_AGE</span><span class="o">=</span><span class="n">cavitte_ages</span><span class="p">)</span>
<span class="n">fl_line_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">irh</span><span class="o">.</span><span class="n">PSX</span><span class="p">,</span> <span class="n">irh</span><span class="o">.</span><span class="n">PSY</span><span class="p">))</span>

<span class="n">pism_ages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">29300</span><span class="p">,</span> <span class="mi">38000</span><span class="p">,</span> <span class="mi">46600</span><span class="p">,</span> <span class="mi">73100</span><span class="p">,</span> <span class="mi">97400</span><span class="p">,</span> <span class="mi">122800</span><span class="p">,</span> <span class="mi">165200</span><span class="p">,</span> <span class="mi">278000</span><span class="p">]</span> <span class="c1"># PISM ages differ slightly since I used a different ice core chronology for the dating than in the original Cavitte et al. 2020 paper</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">Distance</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">irh_layers</span><span class="o">.</span><span class="n">IRH_DEPTH</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">irh_layers</span><span class="o">.</span><span class="n">IRH_AGE</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">Distance</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">irh_layers</span><span class="o">.</span><span class="n">ICE_THK</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bed Depth&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">pism_ages</span><span class="p">:</span>
    <span class="n">age</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">age</span><span class="o">+</span><span class="n">age_offset</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>
    <span class="n">pism_layer</span> <span class="o">=</span> <span class="n">pism_out</span><span class="o">.</span><span class="n">isochronal_layer_depth</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">deposition_time</span><span class="o">=</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pism_depth_interp</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">pism_points</span><span class="p">,</span> <span class="n">pism_layer</span><span class="p">,</span> <span class="n">fl_line_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">Distance</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">pism_depth_interp</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PISM Isochronal Layers&#39;</span><span class="p">)</span>    

<span class="n">pism_bed_depth_interp</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">pism_points</span><span class="p">,</span> <span class="n">pism_out</span><span class="o">.</span><span class="n">thk</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fl_line_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">irh</span><span class="o">.</span><span class="n">Distance</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">pism_bed_depth_interp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PISM Bed Depth&#39;</span><span class="p">)</span>    

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">3500</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance along flight line [km]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Isochronal Layer Depth [m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Isochronal Layer Depth Comparison along Transect&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cavitte et al. 2020 Ages [yr BP]&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f4e3939ba5f13eaa276c5a5e0eb796d4fc90009f8319a111c2ed0d2bcda53266.png" src="_images/f4e3939ba5f13eaa276c5a5e0eb796d4fc90009f8319a111c2ed0d2bcda53266.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="quick_start.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Quick start</p>
      </div>
    </a>
    <a class="right-next"
       href="advanced.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Advanced: Managing the database</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Model-data comparison (ex: PISM)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-layer-mismatch">2D Layer mismatch</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pism-output">PISM output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#query-the-antadatabase">Query the AntADatabase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-pism">Interpolate PISM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#xarray">xarray</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#h5py">h5py</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting">Plotting</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-transect-mismatch">1D Transect mismatch</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Antoine Hermant
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>